name: Commit stage

on :
  workflow_call:
    secrets:
      GH_TOKEN:
      APPLE_CERTIFICATES_P12_BASE64_PASSWORD:
      APPLE_CERTIFICATES_P12_BASE64:
      KEYCHAIN_PASSWORD:
    inputs:
      WINPCAP_ROOT_DESTINATION:
        type: string
        default: "."
      ALTERNATIVE_BASHUTILS_PATH:
        type: string
        default: "."

  # push:
  #   branches: [ dev, main ]
  # pull_request:
  #   branches: [ dev ]
  #   paths-ignore:
  #     - 'Docker'
  #     - '**/README.md'
  #     - '**/LICENCE'

jobs:
  validate:
    runs-on: windows-2022
    outputs:
      runners: ${{ steps.runners-matrix.outputs.runners }}
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Install job dependencies
      shell: bash
      run: |
        choco install -y dos2unix jq
        curl https://www.kikisoft.com/Hive/clang-format/clang-format-7.0.0-LambdaPatch-windows.exe -o clang-format.exe
        ln -s $(pwd)/clang-format.exe /usr/bin/clang-format

    - name: Run fix_files
      shell: bash {0}
      run: |
        alternative_bashutils_path=${{inputs.ALTERNATIVE_BASHUTILS_PATH}}
        $alternative_bashutils_path/scripts/bashUtils/fix_files.sh

    - name: Check for changes
      shell: bash
      run: |
        git diff --name-status --exit-code
        if [ $? -ne 0 ]; then
          echo "Some files need formatting/fixing. Please run the script and commit the changes."
          exit 1
        fi
    - name: prepare-runners-matrix
      id: runners-matrix
      shell: bash
      run: |
        macos=$([ ${{vars.BUILD_MACOS}} = "true"  ] && jq -n --argjson r '${{vars.RUNNER_LABELS_MACOS}}' '$r' || echo '""')
        echo $macos
        linux=$([ ${{vars.BUILD_LINUX}} = "true"  ] && jq -n --argjson r '${{vars.RUNNER_LABELS_LINUX}}' '$r' || echo '""')
        echo $linux
        windows=$([ ${{vars.BUILD_WINDOWS}} = "true"  ] && jq -n --argjson r '${{vars.RUNNER_LABELS_WINDOWS}}' '$r' || echo '""')
        echo $windows

        runners=$(jq -n --argjson m "$macos" --argjson l "$linux" --argjson w "$windows" '[$m,$l,$w]' | jq 'del(.[] | select(. == ""))' | tr -d '\n' )
        echo $runners
        echo "runners=$runners" >> "$GITHUB_OUTPUT"

  build-test:
    needs: validate
    env:
      LC_ALL: en_US.UTF-8

    strategy:
      fail-fast: false
      matrix:
        config:
          - debug
          - release
        runner-label: ${{ fromJSON(needs.validate.outputs.runners) }}

    runs-on: ${{matrix.runner-label}}
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: L-Acoustics/la-mw-gh-action/.github/actions/la-swig@main
      name: Install custom SWIG
      id: la_swig


    - name: Configure runner
      uses: L-Acoustics/la-mw-gh-action/.github/actions/la-configure-runner@main
      with:
        WINPCAP_ROOT_DESTINATION: ${{inputs.WINPCAP_ROOT_FOLDER}}
        APPLE_CERTIFICATES_P12_BASE64_PASSWORD: ${{secrets.APPLE_CERTIFICATES_P12_BASE64_PASSWORD}}
        APPLE_CERTIFICATES_P12_BASE64: ${{secrets.APPLE_CERTIFICATES_P12_BASE64}}
        KEYCHAIN_PASSWORD: ${{secrets.KEYCHAIN_PASSWORD}}
        setup_keychain: "true"

    - name: Build and Test Library
      uses: L-Acoustics/la-mw-gh-action/.github/actions/la-build@main
      with:
        push_bindings: 'false'
        GTEST_FILTER: '-MANUAL*'
        SWIG_EXEC: ${{steps.la_swig.outputs.swig_exec}}
        SWIG_DIR: ${{steps.la_swig.outputs.swig_dir}}
        BUILD_DIR: "${{vars.BUILD_DIR}}"
        include_nuget_la_feed_url: 'false'
        CONFIG: ${{matrix.config}}
        MACOS_SIGNING_IDENTITY: ${{vars.MACOS_SIGNING_IDENTITY}}
        NUGET_CURRENT_FEED_URL: 'https://nuget.pkg.github.com/L-Acoustics/index.json'
        LIB_NAME: "la_networkInterfaceHelper"
        GITHUB_TOKEN: ${{secrets.GH_TOKEN}}
