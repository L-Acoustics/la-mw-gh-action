name: Commit stage

on :
  workflow_call:
    secrets:
      GH_TOKEN:
      APPLE_CERTIFICATES_P12_BASE64_PASSWORD:
      APPLE_CERTIFICATES_P12_BASE64:
      KEYCHAIN_PASSWORD:
    inputs:
      WINPCAP_ROOT_DESTINATION:
        type: string
        default: "."
      ALTERNATIVE_BASHUTILS_PATH:
        type: string
        default: "."
permissions:
  contents: write
  actions: read
  pull-requests: write
  checks: write
  packages: write

env:
  INCLUDE_NUGET_LA_FEED: ${{ vars.INCLUDE_NUGET_LA_FEED || 'false' }}
  NUGET_PUBLISH_FEED_URL: ${{ vars.NUGET_PUBLISH_FEED_URL || format('https://nuget.pkg.github.com/{0}/index.json',github.repository_owner) }}
  BUILD_DIR: ${{ vars.BUILD_DIR || '_build' }}
  MACOS_SIGNING_IDENTITY: ${{ vars.MACOS_SIGNING_IDENTITY }}
  BUILD_WINDOWS: ${{ vars.BUILD_WINDOWS }}
  BUILD_MACOS: ${{ vars.BUILD_MACOS }}
  BUILD_LINUX: ${{ vars.BUILD_LINUX }}
  RELEASE_MACOS: ${{ vars.RELEASE_MACOS }}
  RELEASE_WINDOWS: ${{ vars.RELEASE_WINDOWS }}
  RELEASE_LINUX: ${{ vars.RELEASE_LINUX }}
  GTEST_FILTER: ${{ vars.GTEST_FILTER }}
  LIB_NAME: ${{ vars.LIB_NAME }}
  RUNNER_LABELS_MACOS: ${{ vars.RUNNER_LABELS_MACOS }}
  RUNNER_LABELS_WINDOWS: ${{ vars.RUNNER_LABELS_WINDOWS }}
  RUNNER_LABELS_LINUX: ${{ vars.RUNNER_LABELS_LINUX }}
  RUNNER_LABELS_LINUX_ARM64: ${{ vars.RUNNER_LABELS_LINUX_ARM64 }} || 'ubuntu-22.04-arm'
  APPLE_CERTIFICATES_P12_BASE64_PASSWORD: ${{ secrets.APPLE_CERTIFICATES_P12_BASE64_PASSWORD }}
  APPLE_CERTIFICATES_P12_BASE64: ${{ secrets.APPLE_CERTIFICATES_P12_BASE64 }}
  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

jobs:
  pre-workflow-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Correct secrets and repository variables
        run: |
          required_vars=("BUILD_DIR" "MACOS_SIGNING_IDENTITY" "BUILD_WINDOWS" "BUILD_MACOS" "BUILD_LINUX" "RELEASE_MACOS" "RELEASE_WINDOWS" "RELEASE_LINUX" "GTEST_FILTER" "LIB_NAME" "RUNNER_LABELS_MACOS" "RUNNER_LABELS_WINDOWS" "RUNNER_LABELS_LINUX" "RUNNER_LABELS_LINUX_ARM64")
          required_secrets=("APPLE_CERTIFICATES_P12_BASE64_PASSWORD" "APPLE_CERTIFICATES_P12_BASE64" "KEYCHAIN_PASSWORD")

          printf "Checking required vars..."
          continue=0
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              continue=1
              printf "\n❌ Variable '$var' is not set or is empty."
            fi
          done
          if [ $continue = 0 ];then
            printf "ok.\n"
          fi

          printf "\nChecking required secrets..."
          for secret in "${required_secrets[@]}"; do
            if [ -z "${!secret}" ]; then
              continue=1
              printf "\n❌ Secret '$secret' is not set or is empty."
            fi
          done
          if [ $continue = 0 ];then
            printf "ok.\n"
          fi
          exit $continue


  validate:
    needs: pre-workflow-checks
    runs-on: windows-2022
    outputs:
      matrix: ${{ steps.config-matrix.outputs.matrix }}
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Install job dependencies
      shell: bash
      run: |
        choco install -y dos2unix jq
        curl https://www.kikisoft.com/Hive/clang-format/clang-format-7.0.0-LambdaPatch-windows.exe -o clang-format.exe
        ln -s $(pwd)/clang-format.exe /usr/bin/clang-format

    - name: Run fix_files
      shell: bash {0}
      run: |
        alternative_bashutils_path=${{inputs.ALTERNATIVE_BASHUTILS_PATH}}
        $alternative_bashutils_path/scripts/bashUtils/fix_files.sh

    - name: Check for changes
      shell: bash
      run: |
        git diff --name-status --exit-code
        if [ $? -ne 0 ]; then
          echo "Some files need formatting/fixing. Please run the script and commit the changes."
          exit 1
        fi
    - name: prepare-runners-matrix
      id: config-matrix
      shell: bash
      run: |
        runner_configs=$(echo ${{vars.BUILD_CONFIG}} | jq -c '{"include": .runner_configs,"config":["debug","release"]}' )
        echo $runner_configs
        echo "matrix=$runner_configs" >> "$GITHUB_OUTPUT"

  build-test:
    needs: validate
    env:
      LC_ALL: en_US.UTF-8

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.validate.outputs.matrix) }}
    runs-on: ${{matrix.labels}}
    steps:
    - name: test-matrix
      shell: bash
      run: |
        echo "Matrix values"
        echo "${{matrix.label}}"
        echo "${{matrix.arch}}"

    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: L-Acoustics/la-mw-gh-action/.github/actions/la-swig@main
      name: Install custom SWIG
      id: la_swig


    - name: Configure runner
      uses: L-Acoustics/la-mw-gh-action/.github/actions/la-configure-runner@main
      with:
        WINPCAP_ROOT_DESTINATION: ${{inputs.WINPCAP_ROOT_DESTINATION}}
        APPLE_CERTIFICATES_P12_BASE64_PASSWORD: ${{secrets.APPLE_CERTIFICATES_P12_BASE64_PASSWORD}}
        APPLE_CERTIFICATES_P12_BASE64: ${{secrets.APPLE_CERTIFICATES_P12_BASE64}}
        KEYCHAIN_PASSWORD: ${{secrets.KEYCHAIN_PASSWORD}}
        setup_keychain: "true"

    - name: Build and Test Library
      uses: L-Acoustics/la-mw-gh-action/.github/actions/la-build@main
      with:
        push_bindings: 'false'
        GTEST_FILTER: '${{vars.GTEST_FILTER}}'
        SWIG_EXEC: ${{steps.la_swig.outputs.swig_exec}}
        SWIG_DIR: ${{steps.la_swig.outputs.swig_dir}}
        BUILD_DIR: "${{env.BUILD_DIR}}"
        include_nuget_la_feed_url:  "${{env.INCLUDE_NUGET_LA_FEED}}"
        CONFIG: ${{matrix.config}}
        MACOS_SIGNING_IDENTITY: ${{env.MACOS_SIGNING_IDENTITY}}
        NUGET_PUBLISH_FEED_URL: ${{env.NUGET_PUBLISH_FEED_URL}}
        LIB_NAME: "la_networkInterfaceHelper"
        GITHUB_TOKEN: ${{secrets.GH_TOKEN}}
